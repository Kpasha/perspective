<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow Data Slice Test</title>

    <script src="https://unpkg.com/@finos/perspective/dist/umd/perspective.js"></script>
</head>

<body>
    <script type="module">
        import init, { load_arrow, accessor_pprint, accessor_print_schema, accessor_print_column_names, accessor_get } from './pkg/arrow_data_slice.js';

        async function run() {
            await init();
            const worker = perspective.worker();

            const table = worker.table({
                a: "integer",
                b: "string",
                c: "datetime",
                d: "date",
                e: "float",
                f: "boolean"
            });

            table.update({
                a: [1, 2, 3, null, 4],
                b: ["a", null, "b", "c", "d"],
                c: [null, new Date(), new Date(), new Date(), new Date()],
                d: [new Date(), null, new Date(), new Date(), new Date()],
                e: [1.5, 2.5, null, 3.5, 4.5],
                f: [true, false, true, null, false]
            });

            const view = table.view();
            const arrow = await view.to_arrow();
            let start = performance.now();
            let accessor = load_arrow(new Uint8Array(arrow));

            let num_columns = await view.num_columns();
            let num_rows = await view.num_rows();
            let cols = await view.column_paths();

            let reconstructed = {};

            for (let col of cols) {
                reconstructed[col] = [];
                for (let j = 0; j < num_rows; j++) {
                    reconstructed[col].push(accessor_get(accessor, col, j));
                }
            }
            console.log(`accessor took ${performance.now() - start} seconds`);

            console.log(reconstructed);
            accessor_pprint(accessor);
            accessor_print_schema(accessor);
            accessor_print_column_names(accessor);

            let start2 = performance.now();
            await view.to_json();
            console.log(`to_json() took ${performance.now() - start2} seconds`);
        };
        run();
    </script>
</body>

</html>