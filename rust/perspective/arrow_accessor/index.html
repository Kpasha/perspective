<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow Data Slice Test</title>

    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective/dist/umd/perspective.js"></script>
</head>

<body>
    <script type="module">
        import init, { accessor_make, accessor_get_value, accessor_drop } from './pkg/arrow_accessor.js';

        async function run() {
            await init();
            const worker = perspective.worker();

            const table = worker.table({
                a: "integer",
                b: "string",
                c: "datetime",
                d: "date",
                e: "float",
                f: "boolean"
            });

            table.update({
                a: [1, 2, 3, null, 4],
                b: ["a", null, "b", "c", "d"],
                c: [null, new Date(), new Date(), new Date(), new Date()],
                d: [new Date(), null, new Date(), new Date(), new Date()],
                e: [1.5, 2.5, null, 3.5, 4.5],
                f: [true, false, true, null, false]
            });

            const view = table.view();
            const num_columns = await view.num_columns();
            const num_rows = await view.num_rows();
            const cols = await view.column_paths();
            const arrow = await view.to_arrow();


            let start = performance.now();
            let accessor = accessor_make(new Uint8Array(arrow));

            let reconstructed = {};

            for (let col of cols) {
                reconstructed[col] = [];
                for (let j = 0; j < num_rows; j++) {
                    reconstructed[col].push(accessor_get_value(accessor, col, j));
                }
            }
            console.log(`accessor took ${performance.now() - start} seconds`);

            console.log(reconstructed);

            let start2 = performance.now();
            const json = await view.to_columns();
            console.log(`to_columns() took ${performance.now() - start2} seconds`);

            accessor_drop(accessor);

            const view2 = table.view({columns: ["a", "d", "c"]});
            const num_columns2 = await view2.num_columns();
            const num_rows2 = await view2.num_rows();
            const cols2 = await view2.column_paths();
            const arrow2 = await view2.to_arrow();
            
            console.log(cols2);
            let start3 = performance.now();
            let accessor2 = accessor_make(new Uint8Array(arrow2));

            let reconstructed2 = {};

            for (let col of cols2) {
                reconstructed2[col] = [];
                for (let j = 0; j < num_rows2; j++) {
                    reconstructed2[col].push(accessor_get_value(accessor2, col, j));
                }
            }
            console.log(`accessor2 took ${performance.now() - start3} seconds`);

            console.log(reconstructed2);

            let start4 = performance.now();
            console.log(await view2.to_columns());
            console.log(`columns took ${performance.now() - start4} seconds`);

        };
        run();
    </script>
</body>

</html>